"use strict";var BlocklySimStorage={STORAGE_URL:"https://glowing-fire-4998.firebaseio.com",LOCALSTORAGE_KEY:"simulator",isLinkUrl:function(){return/^#[0-9a-zA-Z]{10,15}$/.test(window.location.hash)},backupBlocks_:function(t,e){if("localStorage"in window){var o=BlocklySimStorage.getConfig_(t,e);window.localStorage.setItem(BlocklySimStorage.LOCALSTORAGE_KEY,JSON.stringify(o))}},getConfig_:function(t,e){var o={};return o.config=e.contentWindow.blockly.getConfig(),o.opened=t.classList.contains("show"),o.isFull=t.classList.contains("full"),o.width=t.dataset.width,o.height=t.dataset.height,o},backupOnUnload:function(t,e){window.addEventListener("unload",function(){BlocklySimStorage.isLinkUrl()||BlocklySimStorage.backupBlocks_(t,e)},!1)},setConfig_:function(t,e,o,i,n){if(e.contentWindow.blockly){n=n||function(){};var a=e.contentWindow.blockly;i.width&&(t.dataset.width=i.width),i.height&&(t.dataset.height=i.height),a.lang(Code.getLang()),i.isFull?t.classList.add("full"):(i.width&&(t.style.width=i.width),i.height&&(t.style.height=i.height)),i.opened?(t.classList.add("show"),o.classList.add("opened")):(t.classList.remove("show"),o.classList.remove("opened")),a.setConfig(i.config,n)}else e.contentWindow.addEventListener("load",function a(){e.contentWindow.removeEventListener("load",a),BlocklySimStorage.setConfig_(t,e,o,i,n)})},restoreBlocks:function(t,e,o){if("localStorage"in window&&window.localStorage[BlocklySimStorage.LOCALSTORAGE_KEY]){var i=JSON.parse(window.localStorage[BlocklySimStorage.LOCALSTORAGE_KEY]);BlocklySimStorage.setConfig_(t,e,o,i)}},link:function(t,e,o){window.addEventListener("hashchange",function i(){window.removeEventListener("hashchange",i);var n=window.location.hash.substring(1);var a=JSON.stringify(BlocklySimStorage.getConfig_(t,e));var l={area:t,frame:e,toggleBtn:o,key:n};BlocklySimStorage.makeRequest_("/blockly","simulator",a,l)},!1)},retrieveXml:function(t,e,o,i){var n={area:e,frame:o,toggleBtn:i};BlocklySimStorage.makeRequest_("/blockly","key",t,n)},httpRequest_:null,makeRequest_:function(t,e,o,i){switch(BlocklySimStorage.httpRequest_=new XMLHttpRequest,BlocklySimStorage.httpRequest_.name=e,BlocklySimStorage.httpRequest_.onreadystatechange=BlocklySimStorage.handleRequest_,e){case"simulator":BlocklySimStorage.httpRequest_.open("PATCH",BlocklySimStorage.STORAGE_URL+t+"/"+i.key+".json"),BlocklySimStorage.httpRequest_.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),BlocklySimStorage.httpRequest_.send(JSON.stringify({simulator:o}));break;case"key":BlocklySimStorage.httpRequest_.open("GET",BlocklySimStorage.STORAGE_URL+t+"/"+o+".json"),BlocklySimStorage.httpRequest_.send()}BlocklySimStorage.httpRequest_.workInfo=i},handleRequest_:function(){if(4==BlocklySimStorage.httpRequest_.readyState){if(200!=BlocklySimStorage.httpRequest_.status)BlocklySimStorage.alert(BlocklySimStorage.HTTPREQUEST_ERROR+"\nhttpRequest_.status: "+BlocklySimStorage.httpRequest_.status);else{var t,e=BlocklySimStorage.httpRequest_.responseText.trim(),o=BlocklySimStorage.httpRequest_.workInfo,i=o.area,n=o.frame,a=o.toggleBtn;if("simulator"==BlocklySimStorage.httpRequest_.name)BlocklySimStorage.monitorChanges_(o);else if("key"==BlocklySimStorage.httpRequest_.name){if(!e.length)return;(e=JSON.parse(e).simulator)&&(t=JSON.parse(e),BlocklySimStorage.setConfig_(i,n,a,t,function(){BlocklySimStorage.monitorChanges_(o)}))}}BlocklySimStorage.httpRequest_=null}},monitorChanges_:function(t){var e=t.frame.contentWindow,o=e.MutationObserver||e.WebKitMutationObserver||e.MozMutationObserver;if(!!o){var i=new o(function(){i.disconnect(),i=null,history.pushState("",document.title,window.location.pathname+window.location.search)});i.observe(e.document.body,{childList:!0,attributes:!0,characterData:!0,subtree:!0})}else console.warn("No support MutationObserver!")}};