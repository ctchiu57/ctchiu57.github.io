!function(t,o){"use strict";var e=!1,c="blocks";function n(t){try{var e=Blockly.Xml.textToDom(t);Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(e,o.workspace),o.tabClick("blocks")}catch(t){BlocklyStorage.alert(MSG.importInvalid,"error")}}function s(e,c){var n=t.localStorage.customBlocks||"";switch(n=n?JSON.parse(n):[],e){case"add":n.push(c);break;case"remove":n=n.filter(function(t){return t!==c})}return n=o.parseCustomBlocks(n),t.localStorage.setItem("customBlocks",JSON.stringify(n)),Promise.resolve().then(function(){return o.loadBlockDefs(c)}).then(function(t){switch(e){case"add":o.addToolbox(t.category,t.toolboxXml),$(".form-custom-blocks .info").html(MSG.customBlockImportSuccess).css({color:"blue"});break;case"remove":o.removeToolbox(t.category,t.toolboxXml),$(".form-custom-blocks .info").html(MSG.customBlockRemoveSuccess).css({color:"blue"})}return o.workspace.updateToolbox(o.getToolBox()),Promise.resolve(!0)})}function r(t){$(".form-custom-blocks .info").html(t).css({color:"red"}),$(".input-custom-blocks").css({"box-shadow":"inset red 0 0 3px"}),$(".input-custom-blocks").one("input",function(){$(".form-custom-blocks .info").html(""),$(this).css({"box-shadow":"inset #999 0 0 3px"})})}function l(t){var o=!0;return t&&"object"==typeof t?($.each(["types","dependencies"],function(e,c){if(!t[c]||!$.isArray(t[c]))return o=!1}),$.each(["category","toolbox"],function(e,c){if(!t[c]||"string"!=typeof t[c])return o=!1}),o):o=!1}function a(){var o=t.localStorage.customBlocks||[];return o&&(o="object"==typeof o?o:JSON.parse(o)),o}o.customTab={init:function(){$(".text-custom-description").html(MSG.customDescription.replace("%1","<code>(blockly.json)</code>")),$("#importFileBtn").on("click",function(t){var o=new FileReader;return t.preventDefault(),!!$("#chooseFile").val()&&!!confirm(MSG.importWarning)&&(o.onload=function(){n(o.result)},void o.readAsText($("#chooseFile")[0].files[0]))}),$("#importFromUrlBtn").on("click",function(t){var o=/^[http|https]+:\/\/blockly\.webduino\.io\/\?*.*#(.*)$/;swal({text:MSG.importUrlText,content:{element:"input",attributes:{placeholder:"http://blockly.webduino.io/?#abcd1234"}}}).then(function(t){if(t){var e=o.exec(t);if(e){var c=e[1];$.getJSON("https://glowing-fire-4998.firebaseio.com/blockly/"+c+".json",function(t){if(!confirm(MSG.importWarning))return!1;n(t.xml)})}else BlocklyStorage.alert(MSG.importInvalid,"error")}})}),$(".tab-trigger").on("click",function(){var t=$(this),o=t.data("tab");$(".tab-trigger").removeClass("active"),t.addClass("active"),$(".tab-content").hide(),$('.tab-content[data-tab="'+o+'"]').show().css("display","flex")}),$(".form-custom-blocks").on("submit",function(t){var o=/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/,e=$(".input-custom-blocks").val();t.preventDefault(),e.indexOf("https://")<0&&e.indexOf("http://")<0&&(e="https://"+e,$(".input-custom-blocks").val(e));var c='<div class="block-def"><a href="'+e+'" title="'+e+'" class="custom-def-link" target="_blank">'+e+'</a> <button class="btn btn-remove-block">'+MSG.customBlockRemove+"</button></div>";$.getJSON(e).done(function(t,o,n){var a=n.getResponseHeader("content-type");if(a.indexOf("json")<0)return r(MSG.customBlockMIMEInvalid),!1;l(t)?($(".block-def-wrapper").append(c),$(".input-custom-blocks").val(""),s("add",e)):r(MSG.customBlockInvalid)}).fail(function(t,c,n){404!==t.status?o.test(e)?r(MSG.customBlockLinkInvalid):r(MSG.customBlockUnknownError+" ("+c+": "+n+")"):r(MSG.customBlockNotFound)})}),$("#content_custom .block-def-wrapper").on("click",".btn-remove-block",function(){var t=o.workspace.getAllBlocks().map(function(t){return t.type}),e=$(this),c=e.prev().text();$.getJSON(c).done(function(o){var n=o.types.every(function(o){return-1===t.indexOf(o)});n?s("remove",c).then(function(){e.parent().remove()}).catch(function(t){console.log(t)}):alert(MSG.customBlockInUse)}).fail(function(t,o,n){e.parent().remove(),s("remove",c)})})},open:function(){if(e=!0,$("#tab_custom").html('<i class="icon-cross"></i>'),"localStorage"in t){var c=t.localStorage.customBlocks,n="";c&&((c="object"==typeof c?c:JSON.parse(c)).forEach(function(t){n+='<div class="block-def"><a href="'+t+'" title="'+t+'" class="custom-def-link" target="_blank">'+t+'</a> <button class="btn btn-remove-block">'+MSG.customBlockRemove+"</button></div>"}),$(".block-def-wrapper").html(n))}var s=$("#btn-export-blocks"),r=Blockly.Xml.workspaceToDom(o.workspace),l=Blockly.Xml.domToPrettyText(r);s.attr({download:"blockly.xml",href:"data:application/octet-stream,"+encodeURIComponent(l)})},close:function(t){e=!1,$("#tab_custom").html('<i class="icon-cog"></i>'),t?c=t:o.tabClick(c)},isOpen:function(){return e},$__add__:function(t){var o=/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/;return t.indexOf("https://")<0&&t.indexOf("http://")<0&&(t="https://"+t),axios.get(t).then(function(o){return console.log("â€‹resp",o),o.headers["content-type"].indexOf("json")<0?{status:!1,message:MSG.customBlockMIMEInvalid,url:t}:l(o.data)?(s("add",t),{status:!0,url:t}):{status:!1,message:MSG.customBlockInvalid,url:t}}).catch(function(e){var c=MSG.customBlockUnknownError;return e.response&&404===e.response.status?c=MSG.customBlockNotFound:o.test(t)&&(c=MSG.customBlockLinkInvalid),{status:!1,message:c,url:t,error:e}})},$__remove__:function(t){var e=o.workspace.getAllBlocks().map(function(t){return t.type});return a().indexOf(t)<0?Promise.resolve({status:!1,url:t,message:"The url is invalid. Please do $__query__ to get the correct."}):axios.get(t).then(function(o){return o.data.types.every(function(t){return-1===e.indexOf(t)})?(s("remove",t),{status:!0,url:t}):{status:!1,url:t,message:MSG.customBlockInUse}}).catch(function(o){return s("remove",t),{status:!1,url:t,error:o}})},$__query__:a}}(window,window.Code);